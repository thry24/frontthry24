  <!-- üîπ Modal para a√±adir colaboraci√≥n -->
  <ion-modal [isOpen]="mostrarModal" (didDismiss)="cerrarModal()">
    <ng-template>
      <ion-header>
        <ion-toolbar color="primary">
          <ion-title>Nueva Colaboraci√≥n</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="cerrarModal()">Cerrar</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>

      <ion-content class="ion-padding">

        <!-- TIPO DE COLABORACI√ìN -->
        <ion-item>
          <ion-label position="stacked">Tipo de colaboraci√≥n</ion-label>
          <ion-select [(ngModel)]="nuevaColaboracion.tipoColaboracion" (ionChange)="onTipoColaboracionChange()">
            <ion-select-option value="inmobiliaria">Con agente de mi inmobiliaria</ion-select-option>
            <ion-select-option value="externo">Con agente externo (mensajes)</ion-select-option>
          </ion-select>
        </ion-item>

        <!-- SELECCI√ìN DE AGENTE -->
        <ion-item *ngIf="nuevaColaboracion.tipoColaboracion === 'inmobiliaria'">
          <ion-label>Agente colaborador</ion-label>
          <ion-select
            [(ngModel)]="nuevaColaboracion.colaboradorEmail"
            (ionChange)="onColaboradorExternoSeleccionado($event.detail.value)"
          >
            <ion-select-option *ngFor="let a of agentesExternos" [value]="a.correo">
              {{ a.nombre }}
            </ion-select-option>
          </ion-select>
        </ion-item>

        <ion-item *ngIf="nuevaColaboracion.tipoColaboracion === 'externo'">
          <ion-label position="stacked">Agente externo (mensajes)</ion-label>
          <ion-select
            [(ngModel)]="nuevaColaboracion.colaboradorEmail"
            (ionChange)="onColaboradorExternoSeleccionado($event.detail.value)"
          >
            <ion-select-option *ngFor="let a of agentesExternos" [value]="a.correo">
              {{ a.nombre }}
            </ion-select-option>
          </ion-select>
        </ion-item>

        <!-- TIPO DE OPERACI√ìN -->
        <ion-item>
          <ion-label position="stacked">Tipo de operaci√≥n</ion-label>
          <ion-select [(ngModel)]="nuevaColaboracion.tipoOperacion">
            <ion-select-option value="Venta">Venta</ion-select-option>
            <ion-select-option value="Renta">Renta</ion-select-option>
          </ion-select>
        </ion-item>

        <!-- PROPIEDAD -->
        <ion-item>
          <ion-label position="stacked">Propiedad</ion-label>
          <ion-select [(ngModel)]="nuevaColaboracion.propiedadId">
            <ion-select-option *ngFor="let p of propiedades" [value]="p._id">
              {{ p.clave || p.tipoPropiedad | titlecase }} - {{ p.tipoOperacion | titlecase }}
            </ion-select-option>
          </ion-select>
<div *ngIf="propiedades?.length">
  <ion-text color="medium">
    <p>Propiedades disponibles: {{ propiedades.length }}</p>
  </ion-text>
</div>

<div *ngIf="!propiedades?.length">
  <ion-text color="danger">
    <p>No hay propiedades publicadas</p>
  </ion-text>
</div>

        </ion-item>

        <!-- COMISI√ìN -->
        <ion-item>
          <ion-label position="stacked">% Comisi√≥n a compartir</ion-label>
          <ion-input type="number" [(ngModel)]="nuevaColaboracion.comision" placeholder="Ej. 50"></ion-input>
        </ion-item>

        <!-- NOTA -->
        <ion-item>
          <ion-label position="stacked">Nota adicional</ion-label>
          <ion-textarea [(ngModel)]="nuevaColaboracion.nota" placeholder="Observaciones o acuerdos..."></ion-textarea>
        </ion-item>

        <!-- SEGUIMIENTO -->
        <ion-item lines="none">
          <ion-label>Activar seguimiento</ion-label>
          <ion-checkbox slot="end" [(ngModel)]="nuevaColaboracion.seguimientoActivo"></ion-checkbox>
        </ion-item>

        <!-- PROPIEDAD ELEGIDA -->
        <ion-item lines="none">
          <ion-label>Propiedad elegida (cliente concret√≥)</ion-label>
          <ion-checkbox slot="end" [(ngModel)]="nuevaColaboracion.propiedadElegida"></ion-checkbox>
        </ion-item>

        <div class="ion-text-center ion-margin-top">
          <ion-button color="success" (click)="guardarNuevaColaboracion()">
            <ion-icon name="save-outline" slot="start"></ion-icon>
            Guardar
          </ion-button>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- üîπ Vista principal -->
  <div class="colaboraciones-wrapper">
    <div class="header-bar">
      <h2>Colaboraciones</h2>
      <ion-button (click)="abrirModal()">+ A√±adir Colaboraci√≥n</ion-button>
    </div>

    <!-- LISTA DE COLABORACIONES -->
    <div class="tabla-scroll">
      <ion-grid class="tabla">
        <ion-row class="encabezado">
          <ion-col>Fecha</ion-col>
          <ion-col>Colaborador</ion-col>
          <ion-col>Tipo Colaboraci√≥n</ion-col>
          <ion-col>Operaci√≥n</ion-col>
          <ion-col>Propiedad</ion-col>
          <ion-col>% Comisi√≥n</ion-col>
          <ion-col>Seguimiento</ion-col>
          <ion-col>Estado</ion-col>
          <ion-col>Acciones</ion-col>
        </ion-row>

        <ion-row *ngFor="let c of colaboraciones" class="contenido">
          <ion-col>{{ c.fechaAlta | date:'dd/MM/yyyy' }}</ion-col>
          <ion-col>{{ c.nombreColaborador || c.colaborador?.nombre }}</ion-col>
          <ion-col>{{ c.tipoColaboracion | titlecase }}</ion-col>
          <ion-col>{{ c.tipoOperacion }}</ion-col>
          <ion-col>{{ c.nombrePropiedad || '‚Äî' }}</ion-col>
          <ion-col>{{ c.comision || '‚Äî' }}%</ion-col>
          <ion-col>
            <ion-badge [color]="c.seguimientoActivo ? 'success' : 'medium'">
              {{ c.seguimientoActivo ? 'S√≠' : 'No' }}
            </ion-badge>
          </ion-col>
          <ion-col>
            <ion-badge [color]="c.estado === 'aceptada' ? 'success' : (c.estado === 'pendiente' ? 'warning' : 'danger')">
              {{ c.estado | titlecase }}
            </ion-badge>
          </ion-col>
          <ion-col>
            <ion-button size="small" fill="outline" color="primary" (click)="verDetalles(c)">
              <ion-icon name="eye-outline"></ion-icon>
            </ion-button>
          </ion-col>
        </ion-row>
      </ion-grid>
    </div>
  </div>