<div class="header-bar">
  <div class="search-wrapper">
    <ion-icon name="search-outline"></ion-icon>
    <input
      [(ngModel)]="searchTerm"
      (input)="onSearchChange()"
      placeholder="Buscar cliente..."
    />
  </div>

  <div class="actions">
    <ion-button fill="solid" size="small" (click)="abrirFormulario()">
      + A√±adir cliente
    </ion-button>
  </div>
</div>

<!-- üîπ Formulario para agregar/editar cliente -->
<div *ngIf="mostrarFormulario" class="formulario-cliente">
  <h3>{{ nuevoCliente._id ? 'Editar cliente' : 'Nuevo cliente' }}</h3>

  <ion-item>
    <ion-label position="stacked">Nombre</ion-label>
    <ion-input [(ngModel)]="nuevoCliente.nombre"></ion-input>
  </ion-item>

  <ion-item>
    <ion-label position="stacked">Correo</ion-label>
    <ion-input [(ngModel)]="nuevoCliente.email"></ion-input>
  </ion-item>

  <ion-item>
    <ion-label position="stacked">Tel√©fono</ion-label>
    <ion-input [(ngModel)]="nuevoCliente.telefono"></ion-input>
  </ion-item>

  <ion-item>
    <ion-label position="stacked">Tipo de cliente</ion-label>
    <ion-select [(ngModel)]="nuevoCliente.tipoCliente">
      <ion-select-option value="comprador">Comprador</ion-select-option>
      <ion-select-option value="propietario">Propietario</ion-select-option>
      <ion-select-option value="arrendatario">Arrendatario</ion-select-option>
    </ion-select>
  </ion-item>

  <ion-item>
    <ion-label position="stacked">Tipo de operaci√≥n</ion-label>
    <ion-select [(ngModel)]="nuevoCliente.tipoOperacion">
      <ion-select-option value="venta">Venta</ion-select-option>
      <ion-select-option value="renta">Renta</ion-select-option>
    </ion-select>
  </ion-item>

  <ion-button expand="block" color="success" (click)="guardarCliente()">
    {{ nuevoCliente._id ? 'Actualizar Cliente' : 'Guardar Cliente' }}
  </ion-button>
</div>

<!-- üîπ Filtros -->
<div class="filters">
  <ion-select
    [(ngModel)]="tipoClienteFiltro"
    (ionChange)="onFiltroChange()"
    interface="popover"
    placeholder="Filtrar por tipo"
  >
    <ion-select-option value="">Todos</ion-select-option>
    <ion-select-option value="propietario">Propietario</ion-select-option>
    <ion-select-option value="comprador">Comprador</ion-select-option>
    <ion-select-option value="arrendatario">Arrendatario</ion-select-option>
    <ion-select-option value="mensaje">Desde mensajes</ion-select-option>
  </ion-select>

  <ion-select
    [(ngModel)]="estadoFiltro"
    (ionChange)="onFiltroChange()"
    interface="popover"
    placeholder="Filtrar por estado"
  >
    <ion-select-option value="">Todos</ion-select-option>
    <ion-select-option value="activo">Activo</ion-select-option>
    <ion-select-option value="inactivo">Inactivo</ion-select-option>
  </ion-select>
</div>

<!-- üîπ Tabla de clientes -->
<div class="tabla-scroll">
  <table class="tabla">
    <thead>
      <tr>
        <th></th>
        <th>Nombre</th>
        <th>Tipo cliente</th>
        <th>Tel√©fono</th>
        <th>Correo</th>
        <th>Tipo operaci√≥n</th>
        <th>Fecha registro</th>
        <th>Origen</th>
        <th>Status</th>
        <th>Acciones</th>
      </tr>
    </thead>

    <tbody>
      <tr *ngFor="let cliente of clientesFiltrados">
        <td><ion-checkbox></ion-checkbox></td>

        <td class="nombre">
          <img
            [src]="cliente.foto || 'https://www.svgrepo.com/show/452030/avatar-default.svg'"
            class="avatar"
          />
          {{ cliente.nombre }}
        </td>

        <td>
          <ion-badge
            [color]="
              cliente.tipoCliente === 'comprador'
                ? 'primary'
                : cliente.tipoCliente === 'arrendatario'
                ? 'warning'
                : cliente.tipoCliente === 'propietario'
                ? 'success'
                : 'medium'
            "
          >
            {{ cliente.tipoCliente || '‚Äî' }}
          </ion-badge>
        </td>

        <td class="telefono">{{ cliente.telefono || '‚Äî' }}</td>
        <td>{{ cliente.email }}</td>
        <td>{{ cliente.tipoOperacion || '‚Äî' }}</td>
        <td>{{ cliente.fechaRegistro | date: 'dd-MMM-yyyy' }}</td>
        <td>
          <ion-chip color="tertiary" *ngIf="cliente.origen === 'mensajes'">
            <ion-icon name="chatbubble-outline"></ion-icon>
            <ion-label>Chat</ion-label>
          </ion-chip>
          <ion-chip color="medium" *ngIf="cliente.origen === 'relacion'">
            <ion-icon name="people-outline"></ion-icon>
            <ion-label>Relaci√≥n</ion-label>
          </ion-chip>
        </td>
        <td>
          <span class="estatus">{{ cliente.status || 'Activo' }}</span>
        </td>

        <td class="acciones">
          <ion-icon
            name="chatbubble-ellipses-outline"
            color="primary"
            title="Abrir chat"
            (click)="abrirChatCon(cliente)"
          ></ion-icon>

          <ion-icon
            name="create-outline"
            color="success"
            (click)="editarCliente(cliente)"
          ></ion-icon>

          <ion-icon
            name="trash-outline"
            color="danger"
            (click)="confirmarEliminacion(cliente)"
          ></ion-icon>
        </td>
      </tr>

      <tr *ngIf="clientesFiltrados.length === 0">
        <td colspan="10" class="sin-clientes">
          <ion-icon name="people-outline"></ion-icon>
          <p>No hay clientes para mostrar.</p>
        </td>
      </tr>
    </tbody>
  </table>
</div>
