<div class="mensajes-agentes-wrapper">
  <div class="encabezado-bar">
    <div class="acciones-filtros">
      <!-- BotÃ³n redactar -->
      <ion-button class="btn-redactar" (click)="abrirModalRedactar()">+ Redactar</ion-button>

      <ion-select class="select-filtro" placeholder="Activas">
        <ion-select-option value="activas">Activas</ion-select-option>
        <ion-select-option value="sin-atender">Sin atender</ion-select-option>
        <ion-select-option value="atendidas">Atendidas</ion-select-option>
      </ion-select>

      <ion-select class="select-filtro" placeholder="Asignada a">
        <ion-select-option *ngFor="let asesor of asesores" [value]="asesor">{{ asesor }}</ion-select-option>
      </ion-select>
    </div>
  </div>

  <div class="barra-filtros-mensajes">
    <p class="contador-conversaciones">Mostrando {{ mensajesAgentes.length }} conversaciones</p>
  </div>

  <div class="conversaciones-layout" [class.expandida]="!mensajeSeleccionado">
    <!-- LISTA -->
    <div class="conversaciones-lista" [class.completa]="!mensajeSeleccionado">
      <div *ngFor="let mensaje of mensajesAgentes" class="conversacion-item" (click)="seleccionarMensaje(mensaje)">
        <div class="avatar-msg">
          <img [src]="mensaje.fotoAgente" />
        </div>
        <div class="mensaje-preview">
          <div class="top-line">
            <span class="name">{{ obtenerNombreConversacion(mensaje) }}</span>
            <span class="hora">{{ mensaje.fecha | date: 'medium' }}</span>
          </div>
          <div class="texto">
            {{ mensaje.texto }}
            <span class="id-propiedad">{{ mensaje.idPropiedad }}</span>
          </div>
        </div>
        <img [src]="mensaje.imagenPropiedad" class="img-mini-prop" />
      </div>
    </div>

    <!-- DETALLE -->
    <div class="detalle-mensaje" *ngIf="mensajeSeleccionado">
      <div class="cerrar-panel" (click)="mensajeSeleccionado = null">
        <ion-icon name="close-outline"></ion-icon>
      </div>

      <div class="acciones-top">
        <ion-button class="btn-responder" (click)="abrirResponder()">
          <ion-icon name="arrow-undo-outline"></ion-icon>
          Responder
        </ion-button>

        <ion-button class="btn-ws" (click)="llamarWhatsApp()">
          <ion-icon name="logo-whatsapp"></ion-icon>
          Enviar WhatsApp
        </ion-button>

        <ion-button class="btn-nota" (click)="abrirModalNota()">
          <ion-icon name="document-text-outline"></ion-icon>
          Agregar nota
        </ion-button>
      </div>

      <div class="mensaje-completo">
        <div class="mensaje-texto">
          <p>{{ mensajeSeleccionado.texto }}</p>
        </div>

        <!-- Responder -->
        <div class="recuadro-respuesta" *ngIf="mostrandoResponder">
          <ion-textarea [(ngModel)]="textoRespuesta" placeholder="Escribe tu respuesta..." rows="3"></ion-textarea>
          <div class="acciones-respuesta">
            <ion-button color="success" (click)="enviarRespuesta()">Enviar</ion-button>
            <ion-button color="medium" fill="clear" (click)="cancelarRespuesta()">Cancelar</ion-button>
          </div>
        </div>

        <div class="info-cliente">
          <h4>{{ mensajeSeleccionado.nombreCliente }}</h4>
          <div class="etiqueta">{{ mensajeSeleccionado.tipoOperacion }}</div>
          <p>{{ mensajeSeleccionado.email }}</p>
          <p>{{ mensajeSeleccionado.telefono }}</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== MODAL REDACTAR ===== -->
<ion-modal [isOpen]="mostrarModalRedactar" (didDismiss)="cerrarModalRedactar()">
  <ng-template>
    <ion-content class="ion-padding modal-redactar">
      <div class="contenido-modal">
        <h2>Redactar mensaje</h2>

        <ion-item>
          <ion-label position="stacked">Selecciona un agente</ion-label>
          <ion-select [(ngModel)]="agenteDestino">
            <ion-select-option *ngFor="let agente of agentesDisponibles" [value]="agente">
              {{ agente }}
            </ion-select-option>
          </ion-select>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Mensaje</ion-label>
          <ion-textarea [(ngModel)]="nuevoMensajeTexto" rows="5" placeholder="Escribe tu mensaje..."></ion-textarea>
        </ion-item>

        <div class="acciones-modal">
          <ion-button color="success" expand="block" (click)="enviarMensajeNuevo()">Enviar</ion-button>
          <ion-button color="medium" expand="block" fill="clear" (click)="cerrarModalRedactar()">Cancelar</ion-button>
        </div>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>
