<div class="mensajes-container">
  <!-- Lista de contactos -->
  <div class="lista-contactos">
    <ion-searchbar placeholder="Buscar contacto..."></ion-searchbar>
    <div *ngFor="let usuario of usuariosDisponibles" (click)="abrirChat(usuario)">
      <div style="display: flex; align-items: center; padding: 8px; cursor: pointer;">
        <img [src]="usuario.fotoPerfil || 'assets/img/default-user.png'" width="40" height="40"
          style="border-radius: 50%; margin-right: 10px;" />
        <div>
          <strong>{{ usuario.username }}</strong>
          <div style="font-size: 12px; color: gray;">{{ usuario.role }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Secci√≥n de chat -->
  <div class="chat-section" *ngIf="chatActivo">
    <div class="chat-header">
      {{ chatActivo.username }}

      <div class="chat-header-icons">
        <ion-icon name="call-outline"></ion-icon>
        <ion-icon name="videocam-outline"></ion-icon>
        <ion-icon name="link-outline" (click)="abrirModalLink()" class="icono-link"></ion-icon>
      </div>
    </div>

    <div class="chat-body">
      <div *ngFor="let msg of mensajes"
        [ngClass]="{ 'enviado': msg.emisorEmail === usuarioActual.email, 'mensaje': true, 'recibido': msg.emisorEmail !== usuarioActual.email }">

        <!-- 1. üìÑ Archivo adjunto -->
        <div *ngIf="msg.archivoUrl">
          <a [href]="'http://localhost:5000/' + msg.archivoUrl" target="_blank">
            <ion-icon name="attach-outline"></ion-icon>
            {{ msg.tipoDocumento || 'Ver documento' }}
          </a>
        </div>

        <!-- 2. üîó Propuesta de propiedades -->
        <ng-container *ngIf="esPropuestaPropiedades(msg.mensaje); else mensajeTexto">
          <div class="tarjeta-propuesta">
            <h4>üè† Propuesta de propiedades</h4>
            <p>Haz clic para ver las propiedades sugeridas:</p>
            <a [href]="obtenerUrlPropuesta(msg.mensaje)" target="_blank" class="btn-propuesta">Ver propuesta</a>
          </div>
        </ng-container>

        <!-- 3. üí¨ Mensaje de texto simple -->
        <ng-template #mensajeTexto>
          <div [innerHTML]="msg.mensaje"></div>
        </ng-template>

        <div style="text-align: right; font-size: 11px; margin-top: 4px;">{{ formatearHora(msg.fecha) }}</div>
      </div>
    </div>

    <div class="chat-footer">
      <ion-icon name="happy-outline"></ion-icon>

      <input [(ngModel)]="nuevoMensaje" placeholder="Escribe un mensaje..." />

      <!-- √çcono de adjuntar archivo -->
      <label for="fileInput">
        <ion-icon name="attach-outline" class="adjuntar-icono"></ion-icon>
      </label>
      <input type="file" id="fileInput" (change)="onArchivoSeleccionado($event)" hidden />

      <!-- Clasificador de tipo de documento -->
      <select *ngIf="archivoSeleccionado" [(ngModel)]="tipoDocumento" class="clasificador-documento">
        <option value="">Tipo de documento</option>
        <option *ngFor="let tipo of tiposDocumento" [value]="tipo">{{ tipo }}</option>
      </select>

      <button class="boton-enviar" (click)="enviarMensaje()">
        <ion-icon name="send-outline"></ion-icon>
      </button>
    </div>
  </div>
</div>

<!-- üîó Modal para compartir enlace -->
<div class="modal-link" *ngIf="mostrarModalLink">
  <div class="modal-contenido">
    <h3>Compartir enlace</h3>
    <input [(ngModel)]="enlaceACompartir" placeholder="https://ejemplo.com..." />
    <div class="botones-modal">
      <button (click)="enviarLink()" class="btn-enviar">Enviar</button>
      <button (click)="cerrarModalLink()" class="btn-cancelar">Cancelar</button>
    </div>
  </div>
</div>
