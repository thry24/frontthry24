<app-header></app-header>
<app-loading></app-loading>

<ion-content [fullscreen]="true">
  <section class="contenedor-filtros-con-fondo">
    <div class="filtros-propiedades">
      <h1 class="titulo-filtro">Filtrar Propiedades</h1>

      <div class="barra-filtros">
        <input
          type="text"
          placeholder="Buscar por palabras clave..."
          [(ngModel)]="keyword"
        />
        <select [(ngModel)]="tipoOperacion">
          <option value="">Tipo de operación</option>
          <option value="renta">Renta</option>
          <option value="venta">Venta</option>
        </select>
        <select [(ngModel)]="estado">
          <option value="">Estado</option>
          <option value="Aguascalientes">Aguascalientes</option>
          <option value="Baja California">Baja California</option>
          <option value="Baja California Sur">Baja California Sur</option>
          <option value="Campeche">Campeche</option>
          <option value="Chiapas">Chiapas</option>
          <option value="Chihuahua">Chihuahua</option>
          <option value="CDMX">Ciudad de México</option>
          <option value="Coahuila">Coahuila</option>
          <option value="Colima">Colima</option>
          <option value="Durango">Durango</option>
          <option value="Estado de México">Estado de México</option>
          <option value="Guanajuato">Guanajuato</option>
          <option value="Guerrero">Guerrero</option>
          <option value="Hidalgo">Hidalgo</option>
          <option value="Jalisco">Jalisco</option>
          <option value="Michoacán">Michoacán</option>
          <option value="Morelos">Morelos</option>
          <option value="Nayarit">Nayarit</option>
          <option value="Nuevo León">Nuevo León</option>
          <option value="Oaxaca">Oaxaca</option>
          <option value="Puebla">Puebla</option>
          <option value="Querétaro">Querétaro</option>
          <option value="Quintana Roo">Quintana Roo</option>
          <option value="San Luis Potosí">San Luis Potosí</option>
          <option value="Sinaloa">Sinaloa</option>
          <option value="Sonora">Sonora</option>
          <option value="Tabasco">Tabasco</option>
          <option value="Tamaulipas">Tamaulipas</option>
          <option value="Tlaxcala">Tlaxcala</option>
          <option value="Veracruz">Veracruz</option>
          <option value="Yucatán">Yucatán</option>
          <option value="Zacatecas">Zacatecas</option>
        </select>

        <select [(ngModel)]="estadoPropiedad">
          <option value="">Estado de la propiedad</option>
          <option *ngFor="let estado of estados" [value]="estado">
            {{ estado | titlecase }}
          </option>
        </select>
        <input
          type="text"
          placeholder="Presupuesto máximo"
          class="precio-input"
          [(ngModel)]="precioMax"
          (input)="formatearPrecio($event)"
        />
      </div>

      <div class="filtros-opcionales-toggle">
        <button
          class="btn-opcionales"
          (click)="mostrarCaracteristicas = !mostrarCaracteristicas"
        >
          <ion-icon
            [name]="mostrarCaracteristicas ? 'remove-outline' : 'add-outline'"
          ></ion-icon>
        </button>
      </div>

      <div *ngIf="mostrarCaracteristicas" class="filtros-opcionales">
        <select [(ngModel)]="caracteristicas.superficie">
          <option value="">Superficie disponible</option>
          <option value="10">Hasta 10 m²</option>
          <option value="20">Hasta 20 m²</option>
          <option value="50">Hasta 50 m²</option>
          <option value="100">Hasta 100 m²</option>
          <option value="500">Más de 100 m²</option>
        </select>

        <input
          type="number"
          placeholder="Cantidad de privados"
          [(ngModel)]="caracteristicas.privados"
        />

        <input
          type="number"
          placeholder="Salas de juntas"
          [(ngModel)]="caracteristicas.salaJuntas"
        />

        <input
          type="number"
          placeholder="Baños privados"
          [(ngModel)]="caracteristicas.banosPrivados"
        />
      </div>

      <div class="buscar-wrapper">
        <button class="btn-buscar" (click)="buscarPropiedades()">Buscar</button>
      </div>
    </div>
  </section>

  <section class="resultados-section">
    <h2 class="titulo-seccion">Oficinas</h2>
    <div class="propiedades-grid">
      <ng-container *ngIf="propiedades.length > 0; else noResultados">
        <a
          class="card-propiedad"
          *ngFor="let propiedad of propiedadesPaginadas"
          [routerLink]="['/detalle-propiedad', propiedad._id]"
        >
          <div class="img-wrapper">
            <img
              [src]="propiedad.imagenPrincipal || 'assets/img/sin-imagen.jpg'"
              alt="imagen"
            />
            <div class="etiqueta">
              {{ propiedad.estadoPropiedad | uppercase }}
            </div>
            <div class="iconos-superiores">
              <ion-icon
                [name]="esFavorito(propiedad._id) ? 'heart' : 'heart-outline'"
                [class.favorito-activo]="esFavorito(propiedad._id)"
                class="icono"
                title="Agregar a favoritos"
                (click)="toggleFavorito(propiedad._id)"
              ></ion-icon>
              <ion-icon
                name="add-circle-outline"
                class="icono"
                title="Comparar"
              ></ion-icon>
            </div>
          </div>

          <div class="card-content">
            <div class="tipo">{{ propiedad.tipoPropiedad | uppercase }}</div>
            <div class="precio">{{ propiedad.precio | currency: 'MXN' }}</div>
            <div class="descripcion">
              {{ propiedad.descripcion?.length > 75 ? (propiedad.descripcion
              |slice:0:75) + '... Ver más' : (propiedad.descripcion ||
              'Sindescripción') }}
            </div>
            <div class="ubicacion">
              <ion-icon name="location-outline"></ion-icon>
              {{ propiedad.direccion?.municipio }}, {{
              propiedad.direccion?.estado }}
            </div>

            <div class="detalles">
              <span *ngIf="propiedad.caracteristicas?.oficina?.superficie">
                <ion-icon name="expand-outline"></ion-icon>
                {{ propiedad.caracteristicas?.oficina?.superficie }} m²
              </span>

              <span *ngIf="propiedad.caracteristicas?.oficina?.privados">
                <ion-icon name="people-outline"></ion-icon>
                {{ propiedad.caracteristicas?.oficina?.privados }} privados
              </span>

              <span *ngIf="propiedad.caracteristicas?.oficina?.salaJuntas">
                <ion-icon name="podium-outline"></ion-icon>
                {{ propiedad.caracteristicas?.oficina?.salaJuntas }} sala(s) de
                juntas
              </span>
            </div>

            <div class="acciones">
              <a
                *ngIf="propiedad.agente?.telefono"
                [href]="'tel:' + propiedad.agente.telefono"
                class="btn-contacto"
              >
                <ion-icon name="call-outline"></ion-icon> Llamar
              </a>

              <a
                *ngIf="propiedad.agente?.correo"
                [href]="'mailto:' + propiedad.agente.correo + '?subject=' + asuntoEmail(propiedad) + '&body=' + cuerpoEmail(propiedad)"
                class="btn-contacto"
              >
                <ion-icon name="mail-outline"></ion-icon> Email
              </a>

              <a
                *ngIf="propiedad.agente?.telefono"
                [href]="'https://wa.me/52' + propiedad.agente.telefono + '?text=' + mensajeWhatsApp(propiedad)"
                class="btn-contacto"
                target="_blank"
              >
                <ion-icon name="logo-whatsapp"></ion-icon> WhatsApp
              </a>
            </div>
          </div>
        </a>
      </ng-container>
      <ng-template #noResultados>
        <div class="mensaje-vacio">
          <ion-icon name="home-outline" style="font-size: 48px"></ion-icon>
          <p>No hay propiedades registradas por el momento.</p>
        </div>
      </ng-template>
    </div>

    <div class="paginacion" *ngIf="totalPaginas() > 1">
      <button
        (click)="cambiarPagina(paginaActual - 1)"
        [disabled]="paginaActual === 1"
      >
        Anterior
      </button>

      <button
        *ngFor="let pagina of [].constructor(totalPaginas()); let i = index"
        (click)="cambiarPagina(i + 1)"
        [class.activa]="paginaActual === i + 1"
      >
        {{ i + 1 }}
      </button>

      <button
        (click)="cambiarPagina(paginaActual + 1)"
        [disabled]="paginaActual === totalPaginas()"
      >
        Siguiente
      </button>
    </div>
  </section>

  <app-footer></app-footer>
</ion-content>
